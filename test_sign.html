<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="web3.min.js"></script>
</head>
<body>
<p>your addr: <span id="addr">wait...</span></p>
<p>verifier addr: <span id="contract">wait...</span></p>
<div>
  message: <input type="text" id="msg"><button id="sign">sign</button>
  <p id="signed_msg"></p>
  <p id="recovered_addr"></p>

</div>

<script>
  // var Web3 = require('web3');
  $(function () {
    if (typeof web3 !== 'undefined') {
      web3 = new Web3(web3.currentProvider);
    } else {
      console.log("Load Metamask");
    }
    console.log(web3);
    var account
    web3.eth.getAccounts(function(error, accounts) {
      account = accounts[0];
      $("#addr").text(account);
      console.log(accounts);
      // if(!web3.currentProvider.isConnected()) {
      //   console.error("Not connected");
      // }
    });


    var addr_contract =  web3.utils.toChecksumAddress("0xed9943D72b0E2D06B326c222693B34bdC65af44B");
    // var abi_contract = []

    // var contr_contract = new web3.eth.Contract(abi_contract, addr_contract);
    var signed_msg
    $("#contract").text(addr_contract);
    $("#sign").on('click', function () {
      console.log(account);
      let message = $("#msg").val()
      // let signature =
      //   web3.eth.sign(msg, account)
      //     .then(signature => {
      //   $("#signed_msg").text(signature);
      // });
      // signed_msg = web3.eth.accounts.hashMessage($("#msg").val());

      let msg2 = "\x19Ethereum Signed Message:\n" + message.length + message;
      const msgParams = [
        {
          type: 'string',      // Any valid solidity type
          name: 'Message',     // Any string label you want
          value: message  // The value to sign
        },
        // {
        //   type: 'uint32',
        //   name: 'A number',
        //   value: '1337'
        // }
      ]
      web3.currentProvider.sendAsync({
        method: 'eth_signTypedData',
        params: [msgParams, account],
        from: account,
      }, function (err, result) {
        if (err) return console.error(err)
        if (result.error) {
          return console.error(result.error.message)
        }
        console.log(result)
        let signature = result.result.substr(2)
        const r = '0x' + signature.slice(0, 64)
        const s = '0x' + signature.slice(64, 128)
        const v = '0x' + signature.slice(128, 130)
        const v_decimal = web3.utils.hexToNumber(v)
        $("#signed_msg").html('signature:'+result.result+'<br>r: '+r+'<br>s: '+s+'<br>v: '+v);
        console.log(web3.eth.accounts.hashMessage(msg2))
        const recovered = web3.eth.accounts.recover(web3.eth.accounts.hashMessage(message), v_decimal, r,s)
        $("#recovered_addr").html(recovered);
        console.log(recovered)
        // if (recovered === account ) {
        //   alert('Recovered signer: ' + account)
        // } else {
        //   alert('Failed to verify signer, got: ' + result)
        // }
      });

    });

  });
</script>
</body>
</html>